<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Superb Hyper ‚Äì Daily Water Readings (Cloud)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2870ea">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    html { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }
    :root {
      --primary: #2870ea;
      --primary-dark: #1851b8;
      --success: #1e843b;
      --danger: #e62739;
      --accent: #ffa502;
      --bg-main: #f5fafd;
      --card-bg: #fff;
      --text-main: #183d5c;
      --shadow: 0 4px 24px rgba(40, 112, 234, 0.10);
      --radius: 18px;
      --bowser: #2870ea;
      --dip: #ffa502;
      --ilembe: #23c181;
      --hydrant: #e62739;
      --avatar-bg: #f3f7fa;
    }
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: var(--bg-main);
      margin: 0; padding: 0; min-height: 100vh;
      color: var(--text-main);
      transition: background .3s, color .3s;
    }
    .dark {
      --bg-main: #212838;
      --card-bg: #232d40;
      --text-main: #e9f2ff;
      --success: #3dcb60;
      --danger: #ff6179;
      --accent: #ffc752;
      --shadow: 0 4px 36px rgba(40,112,234,0.12);
      --avatar-bg: #364053;
    }
    .container {
      background: var(--card-bg);
      max-width: 700px;
      margin: 36px auto 28px auto;
      padding: 32px 20px 24px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      animation: fadeIn 0.8s cubic-bezier(.57,.21,.69,1.25);
    }
    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 12px;
      font-size: 2rem;
      font-weight: 900;
      letter-spacing: 1.2px;
      text-shadow: 0 2px 8px #eaf2fa;
    }
    .brand {
      text-align: center;
      color: var(--primary-dark);
      font-size: 1.17rem;
      font-weight: 700;
      letter-spacing: 0.8px;
      margin-bottom: 16px;
    }
    .top-bar {
      display: flex; gap: 11px; justify-content: flex-end; align-items: center; margin-bottom: 11px; flex-wrap: wrap;
    }
    .csv-btn, .stat-btn, .chart-btn, .pdf-btn, .backup-btn, .restore-btn, .dark-btn, .admin-btn {
      border: none;
      border-radius: 11px;
      font-weight: 700;
      font-family: inherit;
      padding: 9px 16px;
      font-size: 1.04em;
      cursor: pointer;
      margin-bottom: 4px;
      margin-right: 2px;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 10px rgba(40,112,234,0.10);
      transition: background .16s, color .17s, box-shadow .14s;
      outline: none;
    }
    .stat-btn { background: var(--accent); color: var(--text-main);}
    .stat-btn:hover { background: #ffd66b; color: var(--primary-dark);}
    .chart-btn { background: var(--bowser);}
    .chart-btn:hover { background: var(--primary-dark);}
    .csv-btn, .pdf-btn, .backup-btn, .restore-btn { background: var(--success);}
    .csv-btn:hover, .pdf-btn:hover, .backup-btn:hover, .restore-btn:hover { background: #156328;}
    .admin-btn { background: var(--danger);}
    .admin-btn:hover { background: #ad1b29;}
    .dark-btn { background: var(--card-bg); color: var(--primary);}
    .dark-btn:hover { background: var(--primary); color: #fff;}
    @media (max-width: 700px) { .top-bar { flex-direction: column; align-items: stretch; gap: 7px;} }
    .form-row { margin-bottom: 17px; }
    label { font-weight: 600; color: var(--primary); display: block; margin-bottom: 6px;}
    .row {
      display: flex; gap: 10px; margin-bottom: 7px; align-items: center;
      background: #f7fafd;
      border-radius: 8px;
      padding: 7px 0 7px 0;
    }
    .dark .row { background: #242c3c; }
    .row input[type="number"] {
      width: 110px;           /* Wider than before */
      min-width: 110px;
      padding: 8px 10px;
      border: 1px solid #e2e6ed;
      border-radius: 8px;
      font-size: 1.1em;
      text-align: right;
      background: #f6fafd;
      color: var(--text-main);
      box-shadow: 0 1px 2px #eaf2fa;
      transition: all 0.14s ease;
    }
    .row input[type="number"]:focus {
      border: 1.7px solid var(--primary);
      outline: none;
      box-shadow: 0 1px 4px rgba(40,112,234,0.2);
    }
    .row .diff {
      font-weight: 700; color: var(--success); min-width: 54px; text-align: right;
      font-size: 1.07em; letter-spacing: 1.2px;
    }
    textarea, input[type="text"], input[type="date"] {
      width: 100%; border-radius: 8px; border: 1px solid #e2e6ed; font-size: 1.04em; padding: 10px 9px; background: #f7fafd;
      margin-top: 5px; transition: border 0.14s;
      box-shadow: 0 1px 3px #eaf2fa;
      color: var(--text-main);
    }
    textarea:focus, input[type="text"]:focus, input[type="date"]:focus {
      border: 1.7px solid var(--primary);
      outline: none;
    }
    button[type="submit"], .cancel-edit-btn {
      width: 100%;
      background: var(--primary);
      color: #fff;
      padding: 14px 0;
      margin-top: 13px;
      font-weight: 700;
      border-radius: 11px;
      border: none;
      font-size: 1.11em;
      box-shadow: 0 2px 13px #eaf2fa;
      letter-spacing: 0.5px;
      transition: background 0.17s, box-shadow 0.16s;
    }
    button[type="submit"]:hover:not(:disabled) { background: var(--primary-dark);}
    button[type="submit"]:disabled { background: #b1c7f4; cursor: not-allowed;}
    .cancel-edit-btn { background: #888; margin-top: 6px;}
    .cancel-edit-btn:hover { background: #444;}
    .loader, .saving-spinner {
      text-align: center;
      margin-top: 27px;
      color: var(--primary);
      font-weight: 600;
      font-size: 1.1rem;
    }
    .saving-spinner {
      display: inline-block;
      margin: 0 7px 0 7px;
      vertical-align: middle;
      width: 22px; height: 22px;
      border: 3px solid #e6e9f5; border-top: 3px solid var(--primary);
      border-radius: 50%; animation: spin 1.1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .success-msg, .error-msg {
      color: #fff; border-radius: 8px; padding: 8px 0; text-align: center;
      margin-bottom: 11px; font-weight: 600; box-shadow: 0 1px 7px #eaf2fa;
      letter-spacing: .5px;
      animation: fadeInMsg .4s;
    }
    .success-msg { background: var(--success);}
    .error-msg   { background: var(--danger);}
    @keyframes fadeInMsg { from { opacity:0; transform:translateY(-10px);} to {opacity:1;transform:none;} }
    .history-section { overflow-x: auto; width: 100%; }
    .history-table {
      width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 1em;
      background: #fafcff;
      border-radius: 10px;
      box-shadow: 0 1px 7px #eaf2fa;
      min-width: 900px;
    }
    .dark .history-table { background: #232d40;}
    .history-table th, .history-table td {
      padding: 8px 6px; text-align: center; border-bottom: 1px solid #e5eaf3;
      position: relative;
    }
    .history-table th {
      background: #f0f6ff; font-weight: 700; color: var(--primary);
      border-bottom: 2.5px solid #e0e6f2;
      cursor: help;
      position: relative;
    }
    .history-table tr:hover { background: #f3f8ff;}
    .dark .history-table tr:hover { background: #232d40;}
    .action-btn {
      background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1.12em; margin: 0 1px;
      padding: 0 3px; font-weight: 700; transition: color 0.13s;
    }
    .action-btn:hover { color: var(--danger);}
    .avatar {
      display: inline-block;
      background: var(--avatar-bg);
      color: var(--primary-dark);
      border-radius: 50%;
      width: 28px; height: 28px; line-height: 28px;
      font-size: 1.06em; font-weight: 700;
      vertical-align: middle;
      margin-right: 3px;
      box-shadow: 0 1px 2px #eaf2fa;
    }
    @media (max-width: 1000px) {
      .history-section { overflow-x: auto; }
      .history-table { min-width: 700px;}
    }
    @media (max-width: 700px) {
      .container { padding: 8px 1vw; }
      h1 { font-size: 1.11rem; }
      .row input[type="number"] { width: 70px; min-width: 70px; font-size: 1.04em; padding: 6px 8px; }
      .brand { font-size: .97rem; }
    }
    @media print {
      .container, .top-bar, .history-section, .history-table { box-shadow:none !important; }
      .top-bar, .stat-modal, .chart-modal, .admin-popup, .dark-btn { display:none !important;}
      body { background: #fff !important; color: #111 !important;}
    }
    .stat-modal, .chart-modal, .admin-popup, .restore-modal {
      display: none; position: fixed; z-index: 1001;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(40,112,234,0.13);
      justify-content: center; align-items: center;
      transition: background 0.14s;
    }
    .stat-modal.active, .chart-modal.active, .admin-popup.active, .restore-modal.active { display: flex; }
    .stat-panel, .chart-panel, .admin-panel, .restore-panel {
      background: #fff; border-radius: 18px; box-shadow: 0 8px 48px rgba(40,112,234,0.13), 0 1px 16px #eaf2fa;
      padding: 29px 22px 22px 22px; max-width: 540px; width: 97vw;
      max-height: 92vh; overflow-y: auto; color: var(--text-main);
      animation: popupIn .4s cubic-bezier(.51,.13,.36,1.16); position: relative;
    }
    .dark .stat-panel, .dark .chart-panel, .dark .admin-panel, .dark .restore-panel { background: #222b3a; color: #e9f2ff; }
    .stat-title, .chart-title, .admin-title, .restore-title {
      font-weight: 900; color: var(--primary); font-size: 1.19rem; margin-bottom: 12px;
      text-align: center; letter-spacing: 1px; text-shadow: 0 2px 8px #eaf2fa;
    }
    .close-btn {
      position: absolute; right: 11px; top: 9px; font-size: 2em; color: var(--danger);
      background: none; border: none; cursor: pointer; font-weight: 900; padding: 2px 8px;
      transition: color 0.15s;
    }
    .close-btn:hover { color: #ad1b29;}
    .tooltip {
      display:none; position: absolute; z-index:1002; padding: 5px 10px; background: #fff; border:1px solid #e2eaf2;
      color:#222; font-size:.99em; font-weight:500; border-radius:6px; box-shadow:0 1px 6px #eaf2fa;
      max-width: 230px; left: 50%; transform: translateX(-50%); top: 140%;
      pointer-events:none; white-space: pre-line;
    }
    .history-table th:hover .tooltip { display: block;}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(24px);} to   { opacity: 1; transform: translateY(0);} }
    @keyframes popupIn { from { opacity: 0; transform: scale(0.89);} to   { opacity: 1; transform: scale(1);} }

    /* Number Pad Styles */
    #number-pad {
      position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 2px solid #e2e6ed;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1); z-index: 1000; padding: 16px 0; display: none;
      font-family: 'Inter', sans-serif; text-align: center; border-radius: 18px 18px 0 0;
    }
    #number-pad .key {
      padding: 14px; font-size: 1.3em; font-weight: 600; border: 1px solid #e2e6ed;
      background: #f6fafd; border-radius: 8px; cursor: pointer;
      transition: all 0.1s ease;
    }
    #number-pad .key:active {
      background: #e2e6ed;
      transform: scale(0.95);
      border-color: #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Daily Water Readings (Cloud)</h1>
    <div class="brand">Superb Hyper</div>
    <div id="msg"></div>
    <div class="top-bar">
      <button class="csv-btn" onclick="exportCSV()" title="Export to CSV">Export CSV</button>
      <button class="pdf-btn" onclick="exportPDF()" title="Export PDF">Export PDF</button>
      <button class="stat-btn" onclick="showStats()" title="Stats & Analytics">View Stats</button>
      <button class="chart-btn" onclick="showChart()" title="Charts & Trends">Show Chart</button>
      <button class="backup-btn" onclick="backupJSON()" title="Backup Data (JSON)">Backup</button>
      <button class="restore-btn" onclick="openRestore()" title="Restore Backup">Restore</button>
      <button class="admin-btn" onclick="showAdminPopup()" title="Admin Features">&#9881; Admin</button>
      <button class="dark-btn" onclick="toggleDarkMode()" aria-label="Toggle Dark Mode" title="Toggle Dark Mode">üåô</button>
    </div>
    <form id="readingsForm" autocomplete="off">
      <div class="form-row">
        <label for="readingDate">Date</label>
        <input type="date" id="readingDate" required>
      </div>
      <div class="section">
        <label>Bowser Reading</label>
        <div class="row">
          <span>Open</span>
          <input type="number" id="bowserOpen" required oninput="calcDiff('bowser')" onclick="openNumberPad(this)" aria-label="Bowser Opening">
          <span>Close</span>
          <input type="number" id="bowserClose" required oninput="calcDiff('bowser')" onclick="openNumberPad(this)" aria-label="Bowser Closing">
          <span class="diff" id="bowserDiff">-</span>
        </div>
      </div>
      <div class="section">
        <label>Dipstick</label>
        <div class="row">
          <span>Open</span>
          <input type="number" id="dipOpen" required oninput="calcDiff('dip')" onclick="openNumberPad(this)" aria-label="Dipstick Opening">
          <span>Close</span>
          <input type="number" id="dipClose" required oninput="calcDiff('dip')" onclick="openNumberPad(this)" aria-label="Dipstick Closing">
          <span class="diff" id="dipDiff">-</span>
        </div>
      </div>
      <div class="section">
        <label>iLembe Water</label>
        <div class="row">
          <span>Open</span>
          <input type="number" id="ilembeOpen" required oninput="calcDiff('ilembe')" onclick="openNumberPad(this)" aria-label="iLembe Opening">
          <span>Close</span>
          <input type="number" id="ilembeClose" required oninput="calcDiff('ilembe')" onclick="openNumberPad(this)" aria-label="iLembe Closing">
          <span class="diff" id="ilembeDiff">-</span>
        </div>
      </div>
      <div class="section">
        <label>Hydrant</label>
        <div class="row">
          <span>Open</span>
          <input type="number" id="hydrantOpen" required oninput="calcDiff('hydrant')" onclick="openNumberPad(this)" aria-label="Hydrant Opening">
          <span>Close</span>
          <input type="number" id="hydrantClose" required oninput="calcDiff('hydrant')" onclick="openNumberPad(this)" aria-label="Hydrant Closing">
          <span class="diff" id="hydrantDiff">-</span>
        </div>
      </div>
      <div>
        <label class="mini-label" for="countedBy">Counted By</label>
        <input type="text" id="countedBy" maxlength="50" required placeholder="Name of person who counted" aria-label="Counted By">
      </div>
      <div>
        <label class="mini-label" for="checkedBy">Checked By</label>
        <input type="text" id="checkedBy" maxlength="50" required placeholder="Name of person who checked" aria-label="Checked By">
      </div>
      <div>
        <label class="note-label" for="notes">Notes</label>
        <textarea id="notes" placeholder="Add any notes here..." aria-label="Notes"></textarea>
      </div>
      <button type="submit" id="saveBtn">Save Reading</button>
      <button type="button" id="cancelEditBtn" class="cancel-edit-btn" style="display:none;" onclick="cancelEdit()">Cancel Edit</button>
    </form>
    <div id="loader" class="loader" style="display:none;">Loading history...</div>
    <div class="history-section" id="historySection"></div>
  </div>

  <!-- Number Pad Popup -->
  <div id="number-pad">
    <div id="pad-title" style="font-size:1.3em; margin-bottom:12px; color:#183d5c;">Enter Value</div>
    <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:12px; max-width:300px; margin:0 auto;">
      <button onclick="numberPad.add('1')" class="key">1</button>
      <button onclick="numberPad.add('2')" class="key">2</button>
      <button onclick="numberPad.add('3')" class="key">3</button>
      <button onclick="numberPad.add('4')" class="key">4</button>
      <button onclick="numberPad.add('5')" class="key">5</button>
      <button onclick="numberPad.add('6')" class="key">6</button>
      <button onclick="numberPad.add('7')" class="key">7</button>
      <button onclick="numberPad.add('8')" class="key">8</button>
      <button onclick="numberPad.add('9')" class="key">9</button>
      <button onclick="numberPad.clear()" class="key" style="background:#e62739;color:white;">C</button>
      <button onclick="numberPad.add('0')" class="key">0</button>
      <button onclick="numberPad.backspace()" class="key" style="background:#ffa502;">‚Üê</button>
    </div>
    <button onclick="numberPad.close()" style="margin-top:16px; padding:10px 20px; background:#888; color:white; border:none; border-radius:8px; font-size:1.1em; font-weight:600;">Done</button>
  </div>

  <!-- Stats Popup -->
  <div class="stat-modal" id="statModal">
    <div class="stat-panel" id="statPanel">
      <button class="close-btn" onclick="closeStats()" title="Close">&times;</button>
      <div class="stat-title">Summary Stats</div>
      <div id="statsContent"></div>
    </div>
  </div>
  <!-- Chart Popup -->
  <div class="chart-modal" id="chartModal">
    <div class="chart-panel" id="chartPanel">
      <button class="close-btn" onclick="closeChart()" title="Close">&times;</button>
      <div class="chart-title">Usage Chart</div>
      <div class="chart-controls">
        <div class="chart-type-group">
          <button class="chart-type-btn selected" id="btnLine" onclick="setChartType('line')" type="button">Line</button>
          <button class="chart-type-btn" id="btnBar" onclick="setChartType('bar')" type="button">Bar</button>
          <button class="chart-type-btn" id="btnStacked" onclick="setChartType('stacked')" type="button">Stacked Bar</button>
          <button class="chart-type-btn" id="btnPie" onclick="setChartType('pie')" type="button">Pie</button>
        </div>
        <div>
          <label class="series-label bowser">
            <input class="series-toggle" type="checkbox" id="showBowser" checked onchange="updateChart()"/> Bowser
          </label>
          <label class="series-label dip">
            <input class="series-toggle" type="checkbox" id="showDip" checked onchange="updateChart()"/> Dipstick
          </label>
          <label class="series-label ilembe">
            <input class="series-toggle" type="checkbox" id="showIlembe" checked onchange="updateChart()"/> iLembe
          </label>
          <label class="series-label hydrant">
            <input class="series-toggle" type="checkbox" id="showHydrant" checked onchange="updateChart()"/> Hydrant
          </label>
          <label class="series-label">
            <input class="series-toggle" type="checkbox" id="showTotal" onchange="updateChart()"/> Daily Total
          </label>
        </div>
      </div>
      <canvas id="chartCanvas"></canvas>
    </div>
  </div>
  <!-- Admin password popup -->
  <div class="admin-popup" id="adminPopup">
    <div class="admin-panel">
      <button class="close-btn" onclick="closeAdminPopup()" title="Close">&times;</button>
      <div class="admin-title">Enter Admin Password</div>
      <input type="password" id="adminPassInput" placeholder="Password" style="width:98%;margin-bottom:12px;">
      <button onclick="submitAdminPassword()" class="csv-btn" style="width:100%;">Unlock Admin</button>
      <div id="adminMsg" style="margin-top:10px;color:var(--danger);font-weight:600;"></div>
    </div>
  </div>
  <!-- Restore backup popup -->
  <div class="restore-modal" id="restoreModal">
    <div class="restore-panel">
      <button class="close-btn" onclick="closeRestore()" title="Close">&times;</button>
      <div class="restore-title">Restore Data from Backup</div>
      <input type="file" id="restoreFile" accept="application/json" style="width:98%;margin-bottom:8px;">
      <button onclick="doRestore()" class="csv-btn" style="width:100%;">Restore</button>
      <div style="color:var(--danger);font-weight:600;margin-top:10px;">Warning: This will replace all data!</div>
    </div>
  </div>

  <script>
    // --- Virtual Number Pad ---
    const numberPad = {
      activeInput: null,

      open(input) {
        this.activeInput = input;
        document.getElementById('number-pad').style.display = 'block';
        document.getElementById('pad-title').textContent = `Value: ${input.value || '0'}`;
        input.blur(); // Prevent default keyboard
      },

      add(digit) {
        const input = this.activeInput;
        input.value = (input.value || '') + digit;
        document.getElementById('pad-title').textContent = `Value: ${input.value}`;
        this.triggerCalc();
      },

      clear() {
        this.activeInput.value = '';
        document.getElementById('pad-title').textContent = 'Value: 0';
        this.triggerCalc();
      },

      backspace() {
        const val = this.activeInput.value || '';
        this.activeInput.value = val.slice(0, -1);
        document.getElementById('pad-title').textContent = `Value: ${this.activeInput.value || '0'}`;
        this.triggerCalc();
      },

      close() {
        document.getElementById('number-pad').style.display = 'none';
        this.activeInput = null;
      },

      triggerCalc() {
        const id = this.activeInput.id;
        if (id.includes('bowser')) calcDiff('bowser');
        else if (id.includes('dip')) calcDiff('dip');
        else if (id.includes('ilembe')) calcDiff('ilembe');
        else if (id.includes('hydrant')) calcDiff('hydrant');
      }
    };

    function openNumberPad(input) {
      numberPad.open(input);
    }

    // Tooltips for table headers
    const tooltips = {
      "Date": "The date of the reading.\nSelect or type to add/edit past/future readings.",
      "Bowser": "Manual water bowser readings.\nShows opening, closing, and usage.",
      "Dipstick": "Fuel dipstick tank readings.\nOpening, closing, and daily usage.",
      "iLembe": "iLembe Water meter readings.",
      "Hydrant": "Fire hydrant readings (if used for water).",
      "Counted By": "Who counted/measured these readings.",
      "Checked By": "Who verified/approved the readings.",
      "Notes": "Optional remarks about the day.",
      "Action": "Edit or delete (admin only)."
    };
    window.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(()=>{
        document.querySelectorAll('.history-table th').forEach(th=>{
          const text = th.textContent.trim();
          if (tooltips[text]) {
            let tooltip = document.createElement('div');
            tooltip.className = "tooltip";
            tooltip.innerHTML = tooltips[text].replace(/\n/g,"<br>");
            th.appendChild(tooltip);
          }
        });
      }, 400);
    });

    // JSONBin Setup
    const binId = "686b9c1b8561e97a5032ef3e";
    const apiKey = "$2a$10$rMDjhTzn1yDfnMMAec0fW.Ok54iIQijr5K2OixHy8gaxSF.UMSw.S";
    const url = `https://api.jsonbin.io/v3/b/${binId}`;
    const ADMIN_PASS = "Superb@123";
    const COMPANY_NAME = "Superb Hyper";
    let readingsHistory = [];
    let editingIdx = null;
    let editingDate = null;
    let adminMode = false;
    let loading = true;
    let chartInstance = null;
    let chartType = 'line';
    let lastMsgTimeout = null;
    let darkMode = false;

    function calcDiff(section) {
      const open = Number(document.getElementById(section + 'Open').value) || 0;
      const close = Number(document.getElementById(section + 'Close').value) || 0;
      let diff;
      if (section === "dip") {
        diff = open - close; // Dipstick: opening minus closing
      } else {
        diff = close - open; // Others: closing minus opening
      }
      document.getElementById(section + 'Diff').textContent = (open || close) ? diff : '-';
    }

    function getTodayString() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }

    function initials(name) {
      if (!name) return "";
      return name.split(/\s+/).map(w=>w[0]).join('').toUpperCase().slice(0,2);
    }

    function randomColor(str) {
      let hash = 0; for (let i=0;i<str.length;i++) hash = str.charCodeAt(i) + ((hash<<5)-hash);
      let h = hash%360; return `hsl(${h}, 60%, 80%)`;
    }

    function showMsg(text, ok=true) {
      clearTimeout(lastMsgTimeout);
      let msg = document.getElementById('msg');
      msg.innerHTML = `<div class="${ok?'success-msg':'error-msg'}">${text}</div>`;
      lastMsgTimeout = setTimeout(()=>{ msg.innerHTML=''; }, 3200);
    }

    function showSavingSpinner(show) {
      document.getElementById('saveBtn').innerHTML = show
        ? `<span class="saving-spinner"></span>Saving...`
        : (editingIdx!==null?"Update":"Save Reading");
    }

    function setDarkMode(on) {
      document.body.classList.toggle("dark", !!on);
      darkMode = !!on;
      document.querySelector('.dark-btn').textContent = darkMode ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("darkMode", darkMode ? "1" : "");
    }

    function toggleDarkMode() { setDarkMode(!darkMode); }

    function showAdminPopup() {
      document.getElementById('adminPopup').classList.add("active");
      document.getElementById('adminPassInput').focus();
    }

    function closeAdminPopup() {
      document.getElementById('adminPopup').classList.remove("active");
      document.getElementById('adminMsg').textContent = "";
      document.getElementById('adminPassInput').value = "";
    }

    function submitAdminPassword() {
      let val = document.getElementById('adminPassInput').value.trim();
      if (val === ADMIN_PASS) {
        adminMode = true;
        showMsg("Admin unlocked!",true);
        closeAdminPopup();
        renderHistory();
      } else {
        document.getElementById('adminMsg').textContent = "Incorrect password!";
      }
    }

    async function loadHistory() {
      loading = true;
      document.getElementById('loader').style.display = '';
      document.getElementById('saveBtn').disabled = true;
      try {
        const res = await fetch(url + '/latest', {
          headers: { "X-Access-Key": apiKey }
        });
        if (!res.ok) throw new Error('Could not load data from cloud.');
        const data = await res.json();
        readingsHistory = data.record.dailyReadings || [];
        renderHistory();
        fillOpeningsFromLast();
      } catch (e) {
        showMsg("Could not load from cloud: " + e.message, false);
        readingsHistory = [];
        renderHistory();
        fillOpeningsFromLast();
      } finally {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('saveBtn').disabled = false;
        loading = false;
      }
    }

    async function saveHistory() {
      showSavingSpinner(true);
      document.getElementById('saveBtn').disabled = true;
      try {
        const res = await fetch(url, {
          method: 'PUT',
          headers: {
            "Content-Type": "application/json",
            "X-Access-Key": apiKey
          },
          body: JSON.stringify({ dailyReadings: readingsHistory })
        });
        const data = await res.json();
        if (!res.ok) throw new Error((data && data.message) ? data.message : 'Failed to save to cloud.');
        showMsg("Saved!",true);
        fillOpeningsFromLast();
      } catch (e) {
        showMsg("Cloud save failed: " + (e && e.message ? e.message : e),false);
      } finally {
        showSavingSpinner(false);
        document.getElementById('saveBtn').disabled = false;
      }
    }

    function fillOpeningsFromLast() {
      if (!readingsHistory.length) return;
      const latest = [...readingsHistory].sort((a,b)=>b.date.localeCompare(a.date))[0];
      if (editingIdx === null) {
        document.getElementById('bowserOpen').value = latest.bowserClose ?? '';
        document.getElementById('dipOpen').value = latest.dipClose ?? '';
        document.getElementById('ilembeOpen').value = latest.ilembeClose ?? '';
        document.getElementById('hydrantOpen').value = latest.hydrantClose ?? '';
        ['bowser','dip','ilembe','hydrant'].forEach(s=>{
          document.getElementById(s+'Close').value = '';
          document.getElementById(s+'Diff').textContent = '-';
        });
      }
    }

    function cancelEdit() {
      editingIdx = null; editingDate = null;
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.getElementById('saveBtn').textContent = "Save Reading";
      document.getElementById('readingDate').disabled = false;
      readingsForm.reset();
      ['bowser','dip','ilembe','hydrant'].forEach(s => document.getElementById(s+'Diff').textContent='-');
      fillOpeningsFromLast();
    }

    document.getElementById('readingsForm').onsubmit = async function(e) {
      e.preventDefault();
      if (loading) return false;
      const date = document.getElementById('readingDate').value;
      const counted = countedBy.value.trim(), checked = checkedBy.value.trim();
      const notesVal = notes.value.trim();
      const openCloseDiffs = [
        {s:"bowser",open:+bowserOpen.value,close:+bowserClose.value},
        {s:"dip",open:+dipOpen.value,close:+dipClose.value},
        {s:"ilembe",open:+ilembeOpen.value,close:+ilembeClose.value},
        {s:"hydrant",open:+hydrantOpen.value,close:+hydrantClose.value},
      ];
      for(let i=0;i<openCloseDiffs.length;i++) {
        if (openCloseDiffs[i].s === "dip") {
          if (openCloseDiffs[i].open < openCloseDiffs[i].close) {
            showMsg("Error: Dipstick opening cannot be less than closing!", false); return;
          }
        } else {
          if (openCloseDiffs[i].close < openCloseDiffs[i].open) {
            showMsg(`Error: ${openCloseDiffs[i].s.charAt(0).toUpperCase()+openCloseDiffs[i].s.slice(1)} closing < opening!`,false); return;
          }
        }
      }
      if (!counted || !checked) { showMsg("Counted By and Checked By required.",false); return; }
      if (!date) { showMsg("Please select a date.",false); return; }
      let existingIdx = readingsHistory.findIndex(h => h.date === date);
      if (editingIdx === null && existingIdx !== -1) {
        showMsg("A reading for this date already exists. Use Edit.",false); return;
      }
      const data = {
        date,
        bowserOpen:+bowserOpen.value, bowserClose:+bowserClose.value, bowserDiff:+bowserClose.value-+bowserOpen.value,
        dipOpen:+dipOpen.value, dipClose:+dipClose.value, dipDiff:+dipOpen.value-+dipClose.value,
        ilembeOpen:+ilembeOpen.value, ilembeClose:+ilembeClose.value, ilembeDiff:+ilembeClose.value-+ilembeOpen.value,
        hydrantOpen:+hydrantOpen.value, hydrantClose:+hydrantClose.value, hydrantDiff:+hydrantClose.value-+hydrantOpen.value,
        countedBy:counted, checkedBy:checked, notes:notesVal
      };
      if (editingIdx !== null) {
        readingsHistory[editingIdx] = data;
        editingIdx = null; editingDate = null;
        document.getElementById('cancelEditBtn').style.display = 'none';
        document.getElementById('readingDate').disabled = false;
        document.getElementById('saveBtn').textContent = "Save Reading";
      } else {
        readingsHistory.push(data);
      }
      renderHistory();
      await saveHistory();
      readingsForm.reset();
      ['bowser','dip','ilembe','hydrant'].forEach(s => document.getElementById(s+'Diff').textContent='-');
      fillOpeningsFromLast();
    }

    function renderHistory() {
      if (readingsHistory.length === 0) {
        document.getElementById('historySection').innerHTML = '<p style="text-align:center;margin-top:15px;">No previous readings saved.</p>';
        return;
      }
      const sorted = [...readingsHistory].sort((a,b)=>b.date.localeCompare(a.date));
      let table = `<table class="history-table" aria-label="Reading History Table">
        <tr>`;
      ["Date","Bowser","Dipstick","iLembe","Hydrant","Counted By","Checked By","Notes","Action"].forEach(h=>{
        table += `<th>${h}${tooltips[h]?'<div class="tooltip">'+tooltips[h].replace(/\n/g,"<br>")+'</div>':''}</th>`;
      });
      table += "</tr>";
      for (let i=0; i<sorted.length; i++) {
        const entry = sorted[i];
        const prev = sorted[i+1];
        function arrow(curr,prev) {
          if (!prev) return "";
          if (curr>prev) return '<span title="Increased" style="color:var(--success);font-size:1.05em">&#8593;</span>';
          if (curr<prev) return '<span title="Decreased" style="color:var(--danger);font-size:1.05em">&#8595;</span>';
          return '<span title="No Change" style="color:#aaa">&#8596;</span>';
        }
        function avatar(name) {
          if (!name) return "";
          return `<span class="avatar" style="background:${randomColor(name)}" aria-label="Initials">${initials(name)}</span>`;
        }
        table += `<tr>
          <td>${entry.date}</td>
          <td>${entry.bowserOpen}&rarr;${entry.bowserClose} <b>(${entry.bowserDiff})</b> ${arrow(entry.bowserDiff,prev?prev.bowserDiff:undefined)}</td>
          <td>${entry.dipOpen}&rarr;${entry.dipClose} <b>(${entry.dipDiff})</b> ${arrow(entry.dipDiff,prev?prev.dipDiff:undefined)}</td>
          <td>${entry.ilembeOpen}&rarr;${entry.ilembeClose} <b>(${entry.ilembeDiff})</b> ${arrow(entry.ilembeDiff,prev?prev.ilembeDiff:undefined)}</td>
          <td>${entry.hydrantOpen}&rarr;${entry.hydrantClose} <b>(${entry.hydrantDiff})</b> ${arrow(entry.hydrantDiff,prev?prev.hydrantDiff:undefined)}</td>
          <td>${avatar(entry.countedBy)}${entry.countedBy||""}</td>
          <td>${avatar(entry.checkedBy)}${entry.checkedBy||""}</td>
          <td style="max-width:110px;overflow-x:auto;">${entry.notes||''}</td>
          <td>`;
        if (adminMode) {
          table += `<button class="action-btn" title="Edit" onclick="editEntryByDate('${entry.date}')">&#9998;</button>
            <button class="action-btn" title="Delete" onclick="deleteEntryByDate('${entry.date}')">&#10006;</button>`;
        } else {
          table += `<button class="action-btn" title="Edit (admin only)" onclick="showAdminPopup()">&#9998;</button>
            <button class="action-btn" title="Delete (admin only)" onclick="showAdminPopup()">&#10006;</button>`;
        }
        table += `</td></tr>`;
      }
      table += '</table>';
      document.getElementById('historySection').innerHTML = table;
    }

    window.editEntryByDate = function(date) {
      if (!adminMode) { showAdminPopup(); return; }
      let idx = readingsHistory.findIndex(e=>e.date===date);
      if (idx === -1) return;
      const entry = readingsHistory[idx];
      document.getElementById('readingDate').value = entry.date;
      document.getElementById('readingDate').disabled = true;
      document.getElementById('bowserOpen').value = entry.bowserOpen;
      document.getElementById('bowserClose').value = entry.bowserClose;
      document.getElementById('dipOpen').value = entry.dipOpen;
      document.getElementById('dipClose').value = entry.dipClose;
      document.getElementById('ilembeOpen').value = entry.ilembeOpen;
      document.getElementById('ilembeClose').value = entry.ilembeClose;
      document.getElementById('hydrantOpen').value = entry.hydrantOpen;
      document.getElementById('hydrantClose').value = entry.hydrantClose;
      document.getElementById('countedBy').value = entry.countedBy || '';
      document.getElementById('checkedBy').value = entry.checkedBy || '';
      document.getElementById('notes').value = entry.notes || '';
      calcDiff('bowser'); calcDiff('dip'); calcDiff('ilembe'); calcDiff('hydrant');
      editingIdx = idx;
      editingDate = entry.date;
      document.getElementById('cancelEditBtn').style.display = '';
      document.getElementById('saveBtn').textContent = "Update";
      window.scrollTo({top: 0, behavior: 'smooth'});
    };

    window.deleteEntryByDate = async function(date) {
      if (!adminMode) { showAdminPopup(); return; }
      let idx = readingsHistory.findIndex(e=>e.date===date);
      if (idx === -1) return;
      if (!confirm("Delete this day's readings?")) return;
      readingsHistory.splice(idx, 1);
      renderHistory();
      await saveHistory();
    };

    window.exportCSV = function() {
      if (readingsHistory.length === 0) return alert("No data to export.");
      let csv = [
        [
          "Date",
          "Bowser Opening","Bowser Closing","Bowser Difference",
          "Dipstick Opening","Dipstick Closing","Dipstick Difference",
          "iLembe Opening","iLembe Closing","iLembe Difference",
          "Hydrant Opening","Hydrant Closing","Hydrant Difference",
          "Counted By", "Checked By",
          "Notes"
        ].join(",")
      ];
      readingsHistory.forEach(e=>{
        csv.push([
          e.date,
          e.bowserOpen, e.bowserClose, e.bowserDiff,
          e.dipOpen, e.dipClose, e.dipDiff,
          e.ilembeOpen, e.ilembeClose, e.ilembeDiff,
          e.hydrantOpen, e.hydrantClose, e.hydrantDiff,
          '"' + (e.countedBy||"").replace(/"/g, '""') + '"',
          '"' + (e.checkedBy||"").replace(/"/g, '""') + '"',
          '"' + (e.notes||"").replace(/"/g, '""') + '"'
        ].join(","));
      });
      const blob = new Blob([csv.join("\r\n")], {type: 'text/csv'});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "daily_water_readings.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    window.exportPDF = function() {
      if (readingsHistory.length === 0) { alert("No data to export."); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text(COMPANY_NAME + " ‚Äì Daily Water Readings", 13, 18);
      doc.setFontSize(12);
      let rows = [["Date","Bowser Diff","Dipstick Diff","iLembe Diff","Hydrant Diff","Counted By","Checked By","Notes"]];
      readingsHistory.slice(-25).reverse().forEach(e=>{
        rows.push([e.date,e.bowserDiff,e.dipDiff,e.ilembeDiff,e.hydrantDiff,e.countedBy,e.checkedBy,e.notes||""]);
      });
      if (typeof doc.autoTable === "function") {
        doc.autoTable({ head: [rows[0]], body: rows.slice(1), startY: 25, styles:{font:"helvetica",fontSize:10,cellPadding:2}});
      } else {
        let y = 30;
        rows.forEach(r=>{
          doc.text(r.join(' | '),10,y);
          y += 7;
        });
      }
      doc.save("daily_water_readings.pdf");
    };

    window.backupJSON = function() {
      if (readingsHistory.length === 0) return alert("No data to backup.");
      const blob = new Blob([JSON.stringify({dailyReadings: readingsHistory},null,2)], {type: 'application/json'});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "superb_water_backup.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    function openRestore() {
      if (!adminMode) { showAdminPopup(); return; }
      document.getElementById('restoreModal').classList.add("active");
    }

    function closeRestore() {
      document.getElementById('restoreModal').classList.remove("active");
      document.getElementById('restoreFile').value = "";
    }

    function doRestore() {
      const file = document.getElementById('restoreFile').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const obj = JSON.parse(e.target.result);
          if (!obj.dailyReadings) throw "File missing dailyReadings array.";
          if (!confirm("Are you sure? This will replace ALL current data.")) return;
          readingsHistory = obj.dailyReadings;
          renderHistory();
          await saveHistory();
          closeRestore();
          showMsg("Restore complete!", true);
        } catch(err) {
          alert("Invalid file: "+err);
        }
      };
      reader.readAsText(file);
    }

    window.showStats = function() {
      if (readingsHistory.length === 0) {
        document.getElementById('statsContent').innerHTML = `<div style="margin:13px;">No stats available yet.</div>`;
      } else {
        const {daily, weekly, monthly} = groupStats(readingsHistory);
        let html = "";
        html += statsTable("Most Recent 5 Days", daily, 5);
        html += statsTable("Most Recent 5 Weeks", weekly, 5);
        html += statsTable("Most Recent 5 Months", monthly, 5);
        document.getElementById('statsContent').innerHTML = html;
      }
      document.getElementById('statModal').classList.add("active");
    };

    window.closeStats = function() {
      document.getElementById('statModal').classList.remove("active");
    };

    window.showChart = function() {
      document.getElementById('chartModal').classList.add('active');
      setTimeout(updateChart, 50);
    };

    window.closeChart = function() {
      document.getElementById('chartModal').classList.remove('active');
      if (chartInstance) chartInstance.destroy();
    };

    window.setChartType = function(type) {
      chartType = type;
      document.getElementById('btnLine').classList.toggle('selected', type === 'line');
      document.getElementById('btnBar').classList.toggle('selected', type === 'bar');
      document.getElementById('btnStacked').classList.toggle('selected', type === 'stacked');
      document.getElementById('btnPie').classList.toggle('selected', type === 'pie');
      updateChart();
    };

    window.updateChart = function() {
      if (!readingsHistory.length) return;
      const sorted = [...readingsHistory].sort((a,b)=>a.date.localeCompare(b.date));
      const labels = sorted.map(e=>e.date);
      const bowser = sorted.map(e=>e.bowserDiff);
      const dip = sorted.map(e=>e.dipDiff);
      const ilembe = sorted.map(e=>e.ilembeDiff);
      const hydrant = sorted.map(e=>e.hydrantDiff);
      const total = sorted.map((e,i)=>bowser[i]+dip[i]+ilembe[i]+hydrant[i]);
      const showBowser = document.getElementById('showBowser').checked;
      const showDip = document.getElementById('showDip').checked;
      const showIlembe = document.getElementById('showIlembe').checked;
      const showHydrant = document.getElementById('showHydrant').checked;
      const showTotal = document.getElementById('showTotal').checked;
      if (chartInstance) chartInstance.destroy();
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      let datasets = [];
      if (chartType==="pie") {
        let lastIdx = labels.length-1;
        let dataPie = [];
        if (showBowser) dataPie.push(bowser[lastIdx]);
        if (showDip) dataPie.push(dip[lastIdx]);
        if (showIlembe) dataPie.push(ilembe[lastIdx]);
        if (showHydrant) dataPie.push(hydrant[lastIdx]);
        let bg = [];
        if (showBowser) bg.push(getComputedStyle(document.documentElement).getPropertyValue('--bowser'));
        if (showDip) bg.push(getComputedStyle(document.documentElement).getPropertyValue('--dip'));
        if (showIlembe) bg.push(getComputedStyle(document.documentElement).getPropertyValue('--ilembe'));
        if (showHydrant) bg.push(getComputedStyle(document.documentElement).getPropertyValue('--hydrant'));
        datasets = [{
          label: "Latest Day's Usage",
          data: dataPie,
          backgroundColor: bg
        }];
        chartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ["Bowser","Dipstick","iLembe","Hydrant"].filter((v,i)=>[showBowser,showDip,showIlembe,showHydrant][i]),
            datasets
          },
          options: { plugins:{ legend:{position:'top'} }, responsive:true }
        });
        return;
      }
      if (showBowser) datasets.push({
        label: 'Bowser', data: bowser,
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bowser'),
        backgroundColor: 'rgba(40,112,234,0.14)',
        pointRadius: 3, fill: chartType==='line'||chartType==='stacked'
      });
      if (showDip) datasets.push({
        label: 'Dipstick', data: dip,
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--dip'),
        backgroundColor: 'rgba(255,165,2,0.16)',
        pointRadius: 3, fill: chartType==='line'||chartType==='stacked'
      });
      if (showIlembe) datasets.push({
        label: 'iLembe', data: ilembe,
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--ilembe'),
        backgroundColor: 'rgba(35,193,129,0.18)',
        pointRadius: 3, fill: chartType==='line'||chartType==='stacked'
      });
      if (showHydrant) datasets.push({
        label: 'Hydrant', data: hydrant,
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--hydrant'),
        backgroundColor: 'rgba(230,39,57,0.19)',
        pointRadius: 3, fill: chartType==='line'||chartType==='stacked'
      });
      if (showTotal) datasets.push({
        label: 'Total', data: total,
        borderColor: '#111', backgroundColor: '#aaa', borderDash: [6,4], borderWidth: 2, pointRadius: 3
      });
      let opts = {
        responsive: true,
        plugins: {
          legend: { display:true, position:'top', labels:{font:{weight:'bold'}} },
          title: { display: false }
        },
        elements: {
          line: { tension: 0.32, fill: chartType==='stacked' }
        },
        scales: {
          x: { ticks: { font: { size: 13 }, color: '#888' } },
          y: { title: { display: true, text: 'Difference', color: '#333', font:{size:13, weight:'bold'}},
                ticks: { font: { size: 13 }, color: '#888' }, grid: { color:'#eaf2fa' }
          }
        }
      };
      if (chartType==='stacked') {
        opts.scales.x.stacked = true; opts.scales.y.stacked = true;
      }
      chartInstance = new Chart(ctx, {
        type: (chartType==='line'||chartType==='stacked')?'line':'bar',
        data: { labels, datasets },
        options: opts
      });
    };

    function groupStats(data) {
      const daily = {}, weekly = {}, monthly = {};
      data.forEach(e => {
        if (!e.date) return;
        daily[e.date] = daily[e.date]||[]; daily[e.date].push(e);
        const weekKey = e.date.slice(0,4)+'-W'+getWeekNum(e.date);
        weekly[weekKey] = weekly[weekKey]||[]; weekly[weekKey].push(e);
        const monKey = getMonthStr(e.date);
        monthly[monKey] = monthly[monKey]||[]; monthly[monKey].push(e);
      });
      return {daily, weekly, monthly};
    }

    function statsTable(label, groups, count=5) {
      let keys = Object.keys(groups).sort().reverse();
      if (count) keys = keys.slice(0, count);
      let html = `<div class="stat-section"><div class="stat-label">${label}</div>`;
      keys.forEach(k=>{
        html += `<div style="font-weight:700; margin-top:7px;">${k}</div>
          <table class="stat-table">${statRows(groups[k])}</table>`;
      });
      html += "</div>";
      return html;
    }

    function statRows(entries) {
      function sum(field) { return entries.reduce((a,b)=>a+(Number(b[field])||0),0); }
      function avg(field) { return entries.length ? sum(field)/entries.length : 0; }
      return `
        <tr><th></th>
            <th>Bowser</th>
            <th>Dipstick</th>
            <th>iLembe</th>
            <th>Hydrant</th>
        </tr>
        <tr>
          <td>Total</td>
          <td>${sum("bowserDiff")}</td>
          <td>${sum("dipDiff")}</td>
          <td>${sum("ilembeDiff")}</td>
          <td>${sum("hydrantDiff")}</td>
        </tr>
        <tr>
          <td>Average</td>
          <td>${avg("bowserDiff").toFixed(2)}</td>
          <td>${avg("dipDiff").toFixed(2)}</td>
          <td>${avg("ilembeDiff").toFixed(2)}</td>
          <td>${avg("hydrantDiff").toFixed(2)}</td>
        </tr>
      `;
    }

    function getWeekNum(dateStr) {
      const d = new Date(dateStr);
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() + 4 - (d.getDay()||7));
      const yearStart = new Date(d.getFullYear(),0,1);
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    function getMonthStr(dateStr) { return dateStr.slice(0,7); }

    // Startup
    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById('readingDate').value = getTodayString();
      setDarkMode(localStorage.getItem("darkMode")==="1");
      loadHistory();
      document.getElementById('adminPassInput').addEventListener('keydown', function(e) {
        if (e.key==="Enter") submitAdminPassword();
      });
    });
  </script>
</body>
</html>